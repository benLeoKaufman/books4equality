<% layout('./layout') -%>

<link rel="stylesheet" href="/bower_components/jquery-ui/themes/smoothness/jquery-ui.css">

<script src="/bower_components/jquery-ui/jquery-ui.min.js"></script>
<script src="/bower_components/handlebars/handlebars.min.js"></script>

<input type="text" id="title">

<label>Category</label>
<select id="tags">
    <option value=""></option>
    <% tags.forEach(function(tag) { %>
        <option value="<%= tag %>"><%= tag %></option>
    <% }) %>
</select>

<label>Order by</label>
<select id="orderby">
    <option value=""></option>
    <option value="title">Title</option>
    <option value="year">Year</option>
</select>

<a id="search" class='btn btn-primary'>Search</a>

<script id="entry-template" type="text/x-handlebars-template">
<div>
    {{#each books}}
    <div class="entry">
        <span>{{title}} ({{year}}) Â· {{isbn}}</span>
        <br>
        {{#each tags}}
        <span class="label label-primary"><a href="">{{this}}</a></span>
        {{/each}}
    </div>
    {{/each}}
</div>
</script>

<div id="results"></div>

<script>
$(function() {
    var source = $("#entry-template").html();
    var template = Handlebars.compile(source);

    $("#search").click(function() {
        var criteria = {};
        ["title", "tags", "orderby"].forEach(function(field) {
            if ($("#" + field).val()) {
                criteria[field] = $("#" + field).val()
            }
        });

        $.getJSON('/api/books', criteria)
            .done(function(books) {
                var html = template({books: books});
                $("#results").html(html);
            })
            .fail(function(data, status, xhr) {
                alert('something went wrong'); // TODO
            });

    });

    $("#title").autocomplete({
        source: function(request, response) {
            $.getJSON('/api/books', {title: request.term})
                .done(function(books) {
                    var data = [];
                    books.forEach(function(book) {
                        data.push(book.title);
                    })
                    response(data);
                })
                .fail(function(data, status, xhr) {
                    alert('something went wrong'); // TODO
                });
        },
        minLength: 3,
        delay: 300
    });

    $("#search").click();
});
</script>
